{% extends "base.html" %}
{% block container %}
	<div id="map"></div>
	<style>
		html, body { height: 100%; }
		 #map { height: 90%;}
	</style>
	<script type="text/javascript">
		function circles(feature, layer_lay){
			var opacities = feature.properties.circles.opacities;
			var lat_longs = feature.geometry.coordinates[0];
			var i = 0;
			for (var op of opacities){
				if(op>0.0 && op<1.0){
					var circle = new L.circle(new L.LatLng(lat_longs[i][1], lat_longs[i][0]), 2000, {
						stroke: true,
						opacity: op, 
						color: feature.style.color,
						fill: true,
						fillColor: feature.style.color, 
						fillOpacity: op,
					});
                    circle.addTo(layer_lay);
				}
				i++;
			}
		}



		var map = L.map('map', {
			center: [36, 138],
			zoom: 6,
			timeDimension: true,
			timeDimensionOptions: {
				timeInterval: "2015-09-01/2015-11-30",
				currentTime: Date.parse("2015-09-01")
			},
			timeDimensionControl: false
			
		});

		var tileLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: 'Â© OpenStreetMap contributors',
			onEachFeature: circles,	
			style: function(feature) {return {"color": feature.style.color};}
		}).addTo(map);
		
		var timeDimensionControl = new L.Control.TimeDimension({
    	playerOptions: {
        	buffer: 1,
        	minBufferReady: -1
    	}
		});
		map.addControl(this.timeDimensionControl);

	L.TimeDimension.Layer.AjaxGeoJSON = L.TimeDimension.Layer.extend({

    initialize: function(layer, options) {
        L.TimeDimension.Layer.prototype.initialize.call(this, layer, options);
        this._currentLoadedTime = 0;
        this._currentTimeData = null;
    },

    onAdd: function(map) {
        L.TimeDimension.Layer.prototype.onAdd.call(this, map);
        if (this._timeDimension) {
            this._getDataForTime(this._timeDimension.getCurrentTime());
        }
    },

    _onNewTimeLoading: function(ev) {
        this._getDataForTime(ev.time);
        return;
    },

    isReady: function(time) {
        return (this._currentLoadedTime == time);
    },

    _update: function() {
        if (!this._map)
            return;
        var layer = L.geoJson(this._currentTimeData, this._baseLayer.options);
        if (this._currentLayer) {
            this._map.removeLayer(this._currentLayer);
        }
        layer.addTo(this._map);
        this._currentLayer = layer;
    },

    _getDataForTime: function(time) {
        if (!this._map) {
            return;
        }
        var d = new Date(time);
        var url = "/data/geojson?date="+d.toISOString();
        var callback = function(status, data) {            
            if (status == 'ok'){
                this._currentTimeData = data;
            } else{
                this._currentTimeData = [];
            }
            this._currentLoadedTime = time;
            if (this._timeDimension && time == this._timeDimension.getCurrentTime() && !this._timeDimension.isLoading()) {
                this._update();
            }
            this.fire('timeload', {
                time: time
            });
        };
        $.getJSON(url, callback.bind(this, 'ok')).fail(callback.bind(this, 'error'));
    },
});

L.timeDimension.layer.ajaxGeoJSON = function(layer, options) {
    return new L.TimeDimension.Layer.AjaxGeoJSON(layer, options);
};

var layer = L.timeDimension.layer.ajaxGeoJSON(tileLayer);
layer.initialize(tileLayer);
layer.onAdd(map);

</script>
{% endblock %}